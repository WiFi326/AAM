<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظرة عامة على الإحصائيات - مدير الموظفين</title>
    <link rel="stylesheet" href="../css/main.css">
    <style>
        /* RTL Support and Custom Styles */
        body {
            font-family: 'IBM Plex Sans', 'Source Sans 3', sans-serif;
            margin: 0;
            padding: 0;
        }
        
        /* Loading Screen Styles */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #064E3B 60%, #047857 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
        }
        
        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Bottom Navigation Styles */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #E5E7EB;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.08);
            z-index: 100;
        }

        .bottom-nav-inner {
            display: flex;
            justify-content: space-between;
            width: 100%;
}
        
        .nav-item {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
            padding: 0.90rem 0;
            font-size: 0.90rem;
            color: #6B7280;
            text-decoration: none;
            transition: all 0.2s ease;
        }
        
        .nav-item:hover {
            background-color: #F3F4F6;
        }
        
        .nav-item.active {
            color: #047857;
            background: rgba(4,120,87,0.08);
        }
        
        .nav-item.active .nav-icon {
            color: #047857;
        }
        
        .nav-item .nav-icon {
            width: 24px;
            height: 24px;
        }
        
        .nav-label {
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        /* Content padding for bottom nav */
        .main-content {
            padding: 2rem;
            padding-bottom: 100px; /* زيادة المسافة للشريط السفلي */
            min-height: 100vh;
            background: #F9FAFB;
            width: 100%;
            box-sizing: border-box;
        }
        
        /* Page Header */
        .page-header {
            margin-bottom: 2rem;
        }
        
        .page-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: #111827;
            margin-bottom: 0.5rem;
        }
        
        .page-description {
            font-size: 1.125rem;
            color: #6B7280;
        }
        
        /* Search Section */
        .search-section {
            background: white;
            border-radius: 1.125rem;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
            border: 1px solid #E5E7EB;
        }
        
        .search-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .search-input {
            flex: 1;
            min-width: 250px;
            height: 52px;
            padding: 0 1.5rem;
            border: 2px solid #E5E7EB;
            border-radius: 0.875rem;
            font-size: 1rem;
            transition: all 0.2s ease;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #059669;
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
        }
        
        .search-btn, .refresh-btn, .export-btn {
            height: 52px;
            padding: 0 2rem;
            border: none;
            border-radius: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            min-width: 120px;
        }
        
        .search-btn {
            background: #059669;
            color: white;
        }
        
        .search-btn:hover {
            background: #047857;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
        }
        
        .refresh-btn {
            background: #6B7280;
            color: white;
        }
        
        .refresh-btn:hover {
            background: #4B5563;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
        }
        
        .export-btn {
            background: #10B981;
            color: white;
        }
        
        .export-btn:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        /* Statistics Table */
        .statistics-table-container {
            background: white;
            border-radius: 1.125rem;
            overflow: hidden;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
            border: 1px solid #E5E7EB;
            margin-bottom: 2rem;
        }
        
        .statistics-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .statistics-table thead {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
        }
        
        .statistics-table th {
            padding: 1.25rem 1.5rem;
            text-align: right;
            font-weight: 600;
            font-size: 1rem;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .statistics-table td {
            padding: 1.25rem 1.5rem;
            text-align: right;
            font-size: 0.95rem;
            border-bottom: 1px solid #E5E7EB;
        }
        
        .statistics-table tbody tr {
            transition: all 0.2s ease;
        }
        
        .statistics-table tbody tr:hover {
            transform: scale(1.01);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        /* Row Color Coding */
        .row-leave {
            background: #FFFFFF;
        }
        
        .row-reward {
            background: #D1FAE5;
        }
        
        .row-violation {
            background: #FEE2E2;
        }
        
        /* Type Badges */
        .type-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border-radius: 0.625rem;
            font-weight: 600;
            font-size: 0.875rem;
        }
        
        .type-leave {
            background: #DBEAFE;
            color: #1E40AF;
        }
        
        .type-reward {
            background: #A7F3D0;
            color: #065F46;
        }
        
        .type-violation {
            background: #FECACA;
            color: #991B1B;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-start;
        }
        
        .action-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.625rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
            min-width: 80px;
        }
        
        .edit-btn {
            background: #DBEAFE;
            color: #1E40AF;
        }
        
        .edit-btn:hover {
            background: #BFDBFE;
            transform: translateY(-2px);
        }
        
        .delete-btn {
            background: #FEE2E2;
            color: #991B1B;
        }
        
        .delete-btn:hover {
            background: #FECACA;
            transform: translateY(-2px);
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
        }
        
        .empty-icon {
            width: 120px;
            height: 120px;
            margin: 0 auto 2rem;
            opacity: 0.3;
        }
        
        .empty-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #374151;
            margin-bottom: 0.5rem;
        }
        
        .empty-description {
            font-size: 1rem;
            color: #6B7280;
        }
        
        /* Notification Styles */
        .notification {
            position: fixed;
            top: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: white;
            padding: 1.25rem 2rem;
            border-radius: 0.875rem;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            z-index: 300;
            display: flex;
            align-items: center;
            gap: 1rem;
            min-width: 350px;
            transition: transform 0.3s ease;
            border: 2px solid #E5E7EB;
        }
        
        .notification.show {
            transform: translateX(-50%) translateY(0);
        }
        
        .notification-icon {
            width: 28px;
            height: 28px;
            flex-shrink: 0;
        }
        
        .notification-message {
            flex: 1;
            font-weight: 600;
            color: #111827;
        }
        
        .notification.success {
            border-color: #10B981;
        }
        
        .notification.success .notification-icon {
            color: #10B981;
        }
        
        .notification.error {
            border-color: #EF4444;
        }
        
        .notification.error .notification-icon {
            color: #EF4444;
        }
        
        /* Confirmation Dialog */
        .confirmation-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 250;
        }
        
        .confirmation-dialog.show {
            display: flex;
        }
        
        .confirmation-content {
            background: white;
            border-radius: 1.125rem;
            padding: 2.5rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }
        
        .confirmation-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 1.5rem;
            color: #F59E0B;
        }
        
        .confirmation-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #111827;
            text-align: center;
            margin-bottom: 1rem;
        }
        
        .confirmation-message {
            font-size: 1rem;
            color: #6B7280;
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .confirmation-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }
        
        .confirm-btn, .cancel-btn {
            padding: 0.875rem 2rem;
            border: none;
            border-radius: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 120px;
        }
        
        .confirm-btn {
            background: #EF4444;
            color: white;
        }
        
        .confirm-btn:hover {
            background: #DC2626;
            transform: translateY(-2px);
        }
        
        .cancel-btn {
            background: #E5E7EB;
            color: #374151;
        }
        
        .cancel-btn:hover {
            background: #D1D5DB;
            transform: translateY(-2px);
        }
        
        /* Mobile Card Layout */
        .mobile-cards {
            display: none;
        }
        
        .stat-card-mobile {
            background: white;
            border-radius: 1.125rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
            border: 1px solid #E5E7EB;
        }
        
        .card-header-mobile {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #E5E7EB;
        }
        
        .card-body-mobile {
            display: grid;
            gap: 0.75rem;
        }
        
        .card-field-mobile {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .field-label-mobile {
            font-weight: 600;
            color: #6B7280;
            font-size: 0.875rem;
        }
        
        .field-value-mobile {
            font-weight: 500;
            color: #111827;
            font-size: 0.95rem;
        }
        
        /* Record Count */
        .record-count {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: #ECFDF5;
            color: #047857;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 0.875rem;
            margin-top: 1rem;
        }
        
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 200;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        /* Responsive Design */
        @media (max-width: 1024px) {
            .statistics-table-container {
                display: none;
            }
            
            .mobile-cards {
                display: block;
            }
        }
        
        @media (max-width: 640px) {
            .main-content {
                padding: 1rem;
                padding-bottom: 80px;
            }
            
            .search-section {
                padding: 1.5rem;
            }
            
            .search-controls {
                flex-direction: column;
            }
            
            .search-input {
                width: 100%;
            }
            
            .search-btn, .refresh-btn, .export-btn {
                width: 100%;
            }
            
            .notification {
                min-width: 90%;
                left: 5%;
                transform: translateX(0) translateY(-100px);
            }
            
            .notification.show {
                transform: translateX(0) translateY(0);
            }
            
            .confirmation-content {
                padding: 2rem;
            }
            
            .page-title {
                font-size: 2rem;
            }
            
            .page-description {
                font-size: 1rem;
            }
        }
    </style>
  
  <script type="module" async src="https://static.rocket.new/rocket-web.js?_cfg=https%3A%2F%2Femployeem5022back.builtwithrocket.new&_be=https%3A%2F%2Fapplication.rocket.new&_v=0.1.12"></script>
  <script type="module" defer src="https://static.rocket.new/rocket-shot.js?v=0.0.2"></script>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <p class="text-white text-xl font-semibold mt-6">جاري التحميل...</p>
    </div>

    <!-- Loading Overlay for Refresh -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="bg-white rounded-lg p-8 flex flex-col items-center">
            <div class="loading-spinner"></div>
            <p class="text-text-primary text-lg font-medium mt-4">جاري تحديث البيانات...</p>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <svg class="notification-icon" fill="currentColor" viewBox="0 0 24 24">
            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
        </svg>
        <span class="notification-message" id="notificationMessage"></span>
    </div>

    <!-- Confirmation Dialog -->
    <div class="confirmation-dialog" id="confirmationDialog">
        <div class="confirmation-content">
            <svg class="confirmation-icon" fill="currentColor" viewBox="0 0 24 24">
                <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
            </svg>
            <h3 class="confirmation-title" id="confirmationTitle">تأكيد الحذف</h3>
            <p class="confirmation-message" id="confirmationMessage">هل أنت متأكد من حذف هذا السجل؟</p>
            <div class="confirmation-buttons">
                <button class="confirm-btn" id="confirmBtn">تأكيد</button>
                <button class="cancel-btn" id="cancelBtn">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="main-content" id="mainContent">
        <!-- Page Header -->
        <section class="page-header">
            <h1 class="page-title">نظرة عامة على الإحصائيات</h1>
            <p class="page-description">تقارير شاملة لجميع سجلات الموظفين</p>
        </section>

        <!-- Search and Export Section -->
        <section class="search-section">
            <div class="search-controls">
                <input 
                    type="text" 
                    class="search-input" 
                    id="employeeSearch" 
                    placeholder="ابحث باسم الموظف..."
                    aria-label="البحث باسم الموظف"
                >
                <button class="search-btn" id="searchBtn">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                    </svg>
                    <span>بحث</span>
                </button>
                <button class="refresh-btn" id="refreshBtn">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                    </svg>
                    <span>تحديث</span>
                </button>
                <button class="export-btn" id="exportBtn">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2v9.67z"/>
                    </svg>
                    <span>تصدير Excel</span>
                </button>
            </div>
            
            <div class="record-count">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                <span>إجمالي السجلات: <span id="recordCount">0</span></span>
            </div>
        </section>

        <!-- Desktop Table View -->
        <section class="statistics-table-container">
            <table class="statistics-table" id="statisticsTable">
                <thead>
                    <tr>
                        <th>اسم الموظف</th>
                        <th>النوع</th>
                        <th>التاريخ</th>
                        <th>التفاصيل</th>
                         <th>الملاحظات</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Table rows will be dynamically inserted here -->
                </tbody>
            </table>
            
            <!-- Empty State -->
            <div class="empty-state" id="emptyState" style="display: none;">
                <svg class="empty-icon" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
                </svg>
                <h3 class="empty-title">لا توجد بيانات</h3>
                <p class="empty-description">لم يتم العثور على أي سجلات في النظام</p>
            </div>
        </section>

        <!-- Mobile Card View -->
        <section class="mobile-cards" id="mobileCards">
            <!-- Cards will be dynamically inserted here -->
        </section>
    </main>

    <!-- Bottom Navigation -->
   <nav class="bottom-nav">
    <div class="bottom-nav-inner">
        <a href="dashboard.html" class="nav-item">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
            </svg>
            <span>الرئيسية</span>
        </a>

        <a href="leaves_management.html" class="nav-item">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
            <span>الإجازات</span>
        </a>

        <a href="rewards_management.html" class="nav-item">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-width="2" d="M13 3l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
            </svg>
            <span>المكافآت</span>
        </a>

        <a href="violations_management.html" class="nav-item">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-width="2" d="M12 9v2m0 4h.01M3.34 16l6.928-12c.77-1.333 2.694-1.333 3.464 0l6.928 12c.77 1.333-.192 3-1.732 3H5.072c-1.54 0-2.502-1.667-1.732-3z"/>
            </svg>
            <span>المخالفات</span>
        </a>

        <a href="statistics_overview.html" class="nav-item active">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-width="2" d="M5 3v18m7-14v14m7-10v10"/>
            </svg>
            <span>الإحصائيات</span>
        </a>

        <a href="break_time_management.html" class="nav-item">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <circle cx="12" cy="12" r="3"/>
            </svg>
            <span>الزمنيات</span>
        </a>

        <a href="settings.html" class="nav-item">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0"/>
            </svg>
            <span>الإعدادات</span>
        </a>
    </div>
</nav>


  <script type="module">
    // Firebase configuration
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getDatabase, ref, onValue } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    const firebaseConfig = {
        apiKey: "AIzaSyA08egvPwqPAJ7Vzv8F8O3aW2hIWOukTyI",
        authDomain: "gg52-f1a35.firebasestorage.app",
        projectId: "gg52-f1a35",
        storageBucket: "gg52-f1a35.firebasestorage.app",
        messagingSenderId: "586005981678",
        appId: "1:586005981678:web:deaff68f8c6580bdd686ff"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    let allStatistics = [];
    let filteredStatistics = [];
    let currentSortColumn = null;
    let currentSortDirection = 'asc';
    let allEmployees = [];

    // ====== LOADING SCREEN ======
    window.addEventListener('load', function() {
        setTimeout(function() {
            const loadingScreen = document.getElementById('loadingScreen');
            if (loadingScreen) loadingScreen.classList.add('hidden');
        }, 1000);
    });

    // ====== NOTIFICATION SYSTEM ======
    function showNotification(message, type = 'success') {
        const notification = document.getElementById('notification');
        const notificationMessage = document.getElementById('notificationMessage');
        const notificationIcon = notification?.querySelector('.notification-icon');
        
        if (!notification || !notificationMessage) return;
        
        notificationMessage.textContent = message;
        notification.className = `notification ${type}`;
        
        if (notificationIcon) {
            if (type === 'success') {
                notificationIcon.innerHTML = '<path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>';
            } else if (type === 'error') {
                notificationIcon.innerHTML = '<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>';
            }
        }
        
        notification.classList.add('show');
        
        setTimeout(function() {
            notification.classList.remove('show');
        }, 3000);
    }

    // ====== CONFIRMATION DIALOG ======
    function showConfirmation(title, message, onConfirm) {
        const dialog = document.getElementById('confirmationDialog');
        const confirmationTitle = document.getElementById('confirmationTitle');
        const confirmationMessage = document.getElementById('confirmationMessage');
        const confirmBtn = document.getElementById('confirmBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        
        if (!dialog || !confirmationTitle || !confirmationMessage || !confirmBtn || !cancelBtn) return;
        
        confirmationTitle.textContent = title;
        confirmationMessage.textContent = message;
        dialog.classList.add('show');
        
        const originalConfirmHandler = confirmBtn.onclick;
        const originalCancelHandler = cancelBtn.onclick;
        
        confirmBtn.onclick = function() {
            onConfirm();
            dialog.classList.remove('show');
            confirmBtn.onclick = originalConfirmHandler;
            cancelBtn.onclick = originalCancelHandler;
        };
        
        cancelBtn.onclick = function() {
            dialog.classList.remove('show');
            confirmBtn.onclick = originalConfirmHandler;
            cancelBtn.onclick = originalCancelHandler;
        };
    }

    // Format date
    function formatDate(dateString) {
        if (!dateString) return 'غير محدد';
        
        try {
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return dateString;
            
            return date.toLocaleDateString('ar-EN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        } catch (error) {
            return dateString;
        }
    }

    // Get type label
    function getTypeLabel(type) {
        const labels = {
            'leave': 'إجازة',
            'reward': 'مكافأة',
            'violation': 'مخالفة'
        };
        return labels[type] || type;
    }

    // Get row class
    function getRowClass(type) {
        const classes = {
            'leave': 'row-leave',
            'reward': 'row-reward',
            'violation': 'row-violation'
        };
        return classes[type] || '';
    }

    // Get type badge class
    function getTypeBadgeClass(type) {
        const classes = {
            'leave': 'type-leave',
            'reward': 'type-reward',
            'violation': 'type-violation'
        };
        return classes[type] || '';
    }

    // Get leave type in Arabic
    function getLeaveTypeArabic(type) {
        const types = {
            'daily': 'يومية',
            'sick': 'مرضية',
            'open': 'مفتوحة',
            'unpaid': 'بدون راتب'
        };
        return types[type] || type;
    }

    // Get severity level in Arabic
    function getSeverityLabel(severity) {
        const labels = {
            'severe': 'شديدة',
            'medium': 'متوسطة',
            'light': 'خفيفة'
        };
        return labels[severity] || severity;
    }

    // دالة لتحميل الموظفين
    function loadEmployees() {
        return new Promise((resolve) => {
            const employeesRef = ref(database, 'employees');
            onValue(employeesRef, (snapshot) => {
                allEmployees = [];
                snapshot.forEach((childSnapshot) => {
                    allEmployees.push({
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    });
                });
                console.log('تم تحميل الموظفين:', allEmployees.length);
                resolve();
            }, (error) => {
                console.error('خطأ في تحميل الموظفين:', error);
                showNotification('حدث خطأ في تحميل بيانات الموظفين', 'error');
                resolve();
            });
        });
    }

    // دالة للحصول على اسم الموظف بناءً على الـ ID
    function getEmployeeName(employeeId) {
        if (!employeeId) return 'غير معروف';
        const employee = allEmployees.find(emp => emp.id === employeeId);
        return employee ? employee.name : 'غير معروف';
    }

    // Load all statistics from Firebase
    async function loadStatistics() {
        console.log('بدء تحميل الإحصائيات...');
        
        // تأكد من تحميل الموظفين أولاً
        if (allEmployees.length === 0) {
            console.log('تحميل الموظفين أولاً...');
            await loadEmployees();
        }
        
        allStatistics = [];
        let loadedCount = 0;
        const totalTypes = 3; // leaves, rewards, violations
        
        // Load leaves
        const leavesRef = ref(database, 'leaves');
        onValue(leavesRef, (snapshot) => {
            console.log('تحميل الإجازات...');
            snapshot.forEach((childSnapshot) => {
                const leave = childSnapshot.val();
                allStatistics.push({
                    id: childSnapshot.key,
                    type: 'leave',
                    employeeName: getEmployeeName(leave.employeeId),
                    date: leave.startDate,
                    details: getLeaveTypeArabic(leave.leaveType) || 'إجازة', // فقط نوع الإجازة
                    notes: '-' // ملاحظات للإجازة تكون "-"
                });
            });
            loadedCount++;
            if (loadedCount === totalTypes) {
                console.log('تم تحميل جميع البيانات');
                updateDisplay();
            }
        }, (error) => {
            console.error('خطأ في تحميل الإجازات:', error);
            loadedCount++;
        });

        // Load rewards
        const rewardsRef = ref(database, 'rewards');
        onValue(rewardsRef, (snapshot) => {
            console.log('تحميل المكافآت...');
            snapshot.forEach((childSnapshot) => {
                const reward = childSnapshot.val();
                allStatistics.push({
                    id: childSnapshot.key,
                    type: 'reward',
                    employeeName: getEmployeeName(reward.employeeId),
                    date: reward.date,
                    details: '-', // التفاصيل للمكافأة تكون "-"
                    notes: reward.reason || 'لا يوجد سبب' // سبب المكافأة في الملاحظات
                });
            });
            loadedCount++;
            if (loadedCount === totalTypes) {
                console.log('تم تحميل جميع البيانات');
                updateDisplay();
            }
        }, (error) => {
            console.error('خطأ في تحميل المكافآت:', error);
            loadedCount++;
        });

        // Load violations
        const violationsRef = ref(database, 'violations');
        onValue(violationsRef, (snapshot) => {
            console.log('تحميل المخالفات...');
            snapshot.forEach((childSnapshot) => {
                const violation = childSnapshot.val();
                allStatistics.push({
                    id: childSnapshot.key,
                    type: 'violation',
                    employeeName: getEmployeeName(violation.employeeId),
                    date: violation.date,
                    details: getSeverityLabel(violation.severity) || 'غير محدد', // مستوى الخطورة
                    notes: violation.reason || 'لا يوجد سبب' // سبب المخالفة في الملاحظات
                });
            });
            loadedCount++;
            if (loadedCount === totalTypes) {
                console.log('تم تحميل جميع البيانات');
                updateDisplay();
            }
        }, (error) => {
            console.error('خطأ في تحميل المخالفات:', error);
            loadedCount++;
        });
    }

    // Update display with current data
    function updateDisplay() {
        console.log('تحديث العرض، عدد السجلات:', allStatistics.length);
        filteredStatistics = [...allStatistics];
        
        // Apply search filter
        const searchTerm = document.getElementById('employeeSearch')?.value.trim().toLowerCase() || '';
        if (searchTerm) {
            filteredStatistics = filteredStatistics.filter(stat => 
                stat.employeeName && stat.employeeName.toLowerCase().includes(searchTerm)
            );
        }

        // Sort data
        if (currentSortColumn) {
            filteredStatistics.sort((a, b) => {
                let aVal = a[currentSortColumn];
                let bVal = b[currentSortColumn];
                
                if (currentSortColumn === 'date') {
                    aVal = new Date(aVal);
                    bVal = new Date(bVal);
                }
                
                if (currentSortDirection === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
        }

        renderTable();
        renderMobileCards();
        updateRecordCount();
    }

    // Render desktop table
    function renderTable() {
        const tableBody = document.getElementById('tableBody');
        const emptyState = document.getElementById('emptyState');
        
        if (!tableBody || !emptyState) return;
        
        if (filteredStatistics.length === 0) {
            tableBody.innerHTML = '';
            emptyState.style.display = 'block';
            return;
        }
        
        emptyState.style.display = 'none';
        
        tableBody.innerHTML = filteredStatistics.map(stat => `
            <tr class="${getRowClass(stat.type)}">
                <td>${stat.employeeName || 'غير معروف'}</td>
                <td>
                    <span class="type-badge ${getTypeBadgeClass(stat.type)}">
                        ${getTypeLabel(stat.type)}
                    </span>
                </td>
                <td>${formatDate(stat.date)}</td>
                <td>${stat.details || '-'}</td>
                <td>${stat.notes || '-'}</td>
            </tr>
        `).join('');
    }

    // Render mobile cards
    function renderMobileCards() {
        const mobileCards = document.getElementById('mobileCards');
        
        if (!mobileCards) return;
        
        if (filteredStatistics.length === 0) {
            mobileCards.innerHTML = '';
            return;
        }
        
        mobileCards.innerHTML = filteredStatistics.map(stat => `
            <div class="stat-card-mobile ${getRowClass(stat.type)}">
                <div class="card-header-mobile">
                    <h3 style="font-size: 1.125rem; font-weight: 700; color: #111827;">${stat.employeeName || 'غير معروف'}</h3>
                    <span class="type-badge ${getTypeBadgeClass(stat.type)}">
                        ${getTypeLabel(stat.type)}
                    </span>
                </div>
                <div class="card-body-mobile">
                    <div class="card-field-mobile">
                        <span class="field-label-mobile">التاريخ:</span>
                        <span class="field-value-mobile">${formatDate(stat.date)}</span>
                    </div>
                    <div class="card-field-mobile">
                        <span class="field-label-mobile">التفاصيل:</span>
                        <span class="field-value-mobile">${stat.details || '-'}</span>
                    </div>
                    <div class="card-field-mobile">
                        <span class="field-label-mobile">الملاحظات:</span>
                        <span class="field-value-mobile">${stat.notes || '-'}</span>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // Update record count
    function updateRecordCount() {
        const recordCountElement = document.getElementById('recordCount');
        if (recordCountElement) {
            recordCountElement.textContent = filteredStatistics.length;
        }
    }

    // ====== INITIALIZE EVENT LISTENERS ======
    document.addEventListener('DOMContentLoaded', async () => {
        console.log('بدء تهيئة الصفحة...');
        
        try {
            // تحميل البيانات
            await loadEmployees();
            await loadStatistics();
            showNotification('تم تحميل البيانات بنجاح', 'success');
        } catch (error) {
            console.error('خطأ في تحميل البيانات:', error);
            showNotification('حدث خطأ في تحميل البيانات', 'error');
        }

        // Search functionality
        const searchBtn = document.getElementById('searchBtn');
        const searchInput = document.getElementById('employeeSearch');
        
        if (searchBtn && searchInput) {
            searchBtn.addEventListener('click', () => {
                const searchTerm = searchInput.value.trim().toLowerCase();
                
                if (searchTerm === '') {
                    filteredStatistics = [...allStatistics];
                } else {
                    filteredStatistics = allStatistics.filter(stat => 
                        stat.employeeName && stat.employeeName.toLowerCase().includes(searchTerm)
                    );
                }
                
                renderTable();
                renderMobileCards();
                updateRecordCount();
                
                if (searchTerm !== '') {
                    const resultCount = filteredStatistics.length;
                    const message = resultCount === 0 ? 
                        'لم يتم العثور على نتائج' : 
                        `تم العثور على ${resultCount} نتيجة`;
                    showNotification(message, resultCount > 0 ? 'success' : 'error');
                }
            });

            // Add Enter key support for search
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchBtn.click();
                }
            });
        }

        // Refresh functionality
        const refreshBtn = document.getElementById('refreshBtn');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', async () => {
                const overlay = document.getElementById('loadingOverlay');
                if (overlay) overlay.classList.remove('hidden');
                
                try {
                    await loadEmployees();
                    allStatistics = [];
                    await loadStatistics();
                    showNotification('تم تحديث البيانات بنجاح', 'success');
                } catch (error) {
                    showNotification('حدث خطأ أثناء تحديث البيانات', 'error');
                    console.error(error);
                } finally {
                    if (overlay) overlay.classList.add('hidden');
                }
            });
        }

        // Export to Excel functionality
        const exportBtn = document.getElementById('exportBtn');
        if (exportBtn) {
            exportBtn.addEventListener('click', () => {
                if (allStatistics.length === 0) {
                    showNotification('لا توجد بيانات للتصدير', 'error');
                    return;
                }
                
                // Sort alphabetically by employee name
                const sortedData = [...allStatistics].sort((a, b) => {
                    const nameA = a.employeeName || 'غير معروف';
                    const nameB = b.employeeName || 'غير معروف';
                    return nameA.localeCompare(nameB, 'ar');
                });
                
                // Create CSV content with proper Arabic encoding
                let csvContent = '\uFEFF'; // UTF-8 BOM for Arabic support
                csvContent += '"اسم الموظف","النوع","التاريخ","التفاصيل","الملاحظات"\n';
                
                sortedData.forEach(stat => {
                    const row = [
                        stat.employeeName || 'غير معروف',
                        getTypeLabel(stat.type),
                        formatDate(stat.date),
                        stat.details || '-',
                        stat.notes || '-'
                    ].map(field => {
                        // Escape quotes and wrap in quotes
                        const escapedField = String(field).replace(/"/g, '""');
                        return `"${escapedField}"`;
                    }).join(',');
                    
                    csvContent += row + '\n';
                });
                
                // Create download link
                try {
                    const blob = new Blob([csvContent], { 
                        type: 'text/csv;charset=utf-8;' 
                    });
                    
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);
                    const today = new Date().toISOString().split('T')[0];
                    
                    link.href = url;
                    link.download = `إحصائيات_الموظفين_${today}.csv`;
                    link.style.visibility = 'hidden';
                    
                    document.body.appendChild(link);
                    link.click();
                    
                    // Cleanup
                    setTimeout(() => {
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                    }, 100);
                    
                    showNotification('تم تصدير البيانات بنجاح', 'success');
                } catch (error) {
                    console.error('Error exporting data:', error);
                    showNotification('فشل تصدير البيانات', 'error');
                }
            });
        }
    });
</script>
    
    <!-- <script id="dhws-dataInjector" src="../public/dhws-data-injector.js"></script> -->
</body>
</html>